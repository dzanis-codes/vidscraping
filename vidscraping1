import requests
import bs4
from bs4 import BeautifulSoup
import sqlite3
import time
import csv
import re

#create database connection and result table
conn = sqlite3.connect('vid_str.db') 
c = conn.cursor()
c.execute('''CREATE TABLE IF NOT EXISTS results
           (name_id INTEGER PRIMARY KEY, uznemums, name, str_reg_nr, address, active_flag, registered_date, closed_date, company_closed, timestamp)''')
# Save (commit) the changes
conn.commit()

name = 'na'
str_reg_nr = 'na'
address = 'na'
active_flag = 'na'
registered_date = 'na'
closed_date = 'na'

#;šo keisu vajag atrunāt. izslēgts un vairs nedarbojas, pretstatā darbojas
#40203011102 un 40203014024 tiem vajag jaunu pazīmi laikam par saimn darbibu
#apakshgadijums - vairaki lemumi: 40003961039
#shim atjaunota darbiba 40003788741
#un pavisam svaigs keiss 40103161907


# un shis tad ir interesants keiss. darbiba aptureta, bet nav izslegts un ir strukturvienibas: 40003964321 un 40103556401

# un darbiba aptureta; izslegts no registra ir strukturvieniba: 40003754995



#algroitms, meklee desctable, ja atrod, tad funkcija 1, ja neatrod funkcija 2
#funkcija 1, meklee Izslēgts no Nodokļu maksātāju reģistra, ja atrod tad saglabaa nulliites, bet ja neatrod, tad [funkcija3?] meklee strukturvienibu sarakstu un to saglaba. Papildus atrod ari vai nu datumu ar kuru ir atjaunota darbiba, vai ari to ka nav atjaunota


#funckija2 esosa



def savaksana(reg_nr):
    url = 'https://www6.vid.gov.lv/STRV/Data'

    files = {
        'IsPhysicalPerson': (None, 'false'),
        'IsLegalPerson': (None, 'true'),
        'Name': (None, None),
        'Surname': (None, None),
        'Code': (None, reg_nr),
        'search': (None, 'Atlasīt'),
        'submit': (None, 'yes')
    }
    headers = {}

    r = requests.post(url, files = files, headers=headers)
    soup = BeautifulSoup(r.text, features="html5lib")
    #print(soup)

    k = soup.find(text=re.compile("darbības apturēšanu"))
    print(k)
    if k != None:
        #šeit vajag divus apakšscenārijus. attiecīgi - vai nu ir tā papildus tabula ar struktūrvienībām vai nav vispār.
        check2 = soup.find(text=re.compile("Izslēgts no Nodokļu maksātāju"))
        print("vai atrada vai ir izslēgts:")
        print(check2)

        if check2 == None:
            registresana(soup, reg_nr)
            #pilna strukturvienibu iergeistresanas funkcija
            
        else:
            #pieregistre to ka uznemums beidzies un nevajag sturkturvienibu
            pass



        uznemums = reg_nr

        ts = time.gmtime()
        timestamp = (time.strftime("%Y-%m-%d %H:%M:%S", ts))
        company_closed = 'bijusi pauze darbībā'
        sql_entry = (uznemums, name, str_reg_nr, address, active_flag, registered_date, closed_date, company_closed, timestamp)
        enter_db(sql_entry)
    else:

        info = soup.find("h2", {"class": "SDVHeader"})
        info_text = info.text
        check_if_closed = info_text.find('izslēgts')
        check_if_works = info_text.find('nav apturēta')
        #print(check_if_closed)
        print(check_if_works)
        if check_if_closed > 0:
            print("closed")
            uznemums = reg_nr

            ts = time.gmtime()
            timestamp = (time.strftime("%Y-%m-%d %H:%M:%S", ts))
            company_closed = 'izslēgts no UR'
            sql_entry = (uznemums, name, str_reg_nr, address, active_flag, registered_date, closed_date, company_closed, timestamp)
            enter_db(sql_entry)
        else:
            try:
                registresana(soup, reg_nr)
            except Exception as e:
            #sql_entry = (a, b, c) need legal address?
                print(check_if_works)
                uznemums = reg_nr

                ts = time.gmtime()
                timestamp = (time.strftime("%Y-%m-%d %H:%M:%S", ts))
                company_closed = 'izslēgts no UR'
                sql_entry = (uznemums, name, str_reg_nr, address, active_flag, registered_date, closed_date, company_closed, timestamp)
                enter_db(sql_entry)
            




def registresana(soup, reg_nr):

    find_header = soup.find_all('h2', text=re.compile('Informācija par nodokļu maksātāja struktūrvienībām'))[0]
    print(find_header)
    correct_table = find_header.find_next_sibling()
    #print(correct_table)




    table = correct_table

    my_table = table.find('tbody')
    #print(my_table)

    rows = my_table.find_all('tr')
    #print(rows)

    for row in rows:
        row_contents = []
        cells = row.find_all('td')
        for cell in cells:
            value = cell.string
            #print(value)

            v_list = value.split()
            clean_value = " ".join(v_list) 
            row_contents.append(clean_value)
        #print(row_contents) #debug mode :)
        name = row_contents[0]
        str_reg_nr = row_contents[1]
        address = row_contents[2]
        active_flag = row_contents[3]
        registered_date = row_contents[4]
        closed_date = row_contents[5]
        uznemums = reg_nr
        company_closed = 'nav izslēgts no UR'
        ts = time.gmtime()
        timestamp = (time.strftime("%Y-%m-%d %H:%M:%S", ts))
        sql_entry = (uznemums, name, str_reg_nr, address, active_flag, registered_date, closed_date, company_closed, timestamp)
        print(sql_entry)
        enter_db(sql_entry)

def enter_db(sql_entry):
    #sql entry should consist of 10 items
    c.execute("INSERT INTO results VALUES (null, ?, ?, ?, ?, ?, ?, ?, ?, ?)", sql_entry)
    conn.commit()
    

#savaksana('40103504912', 'test')



with open('test.txt') as csv_file:
    csv_reader = csv.reader(csv_file, delimiter=',')

    for row in csv_reader:
        print(row)
        reg_nr = row[0]
        savaksana(reg_nr)
        time.sleep(3)
